from functools import cached_property
from operator import attrgetter

from eu5.eu5_file_generator import Eu5FileGenerator
from eu5.text_formatter import Eu5WikiTextFormatter


class TableGenerator(Eu5FileGenerator):

    @cached_property
    def formatter(self) -> Eu5WikiTextFormatter:
        return self.parser.formatter

    def localize(self, key: str, default: str = None) -> str:
        return self.parser.localize(key, default)

    def generate_concept_tables(self):
        concepts = sorted(self.parser.game_concepts.values(), key=attrgetter('family', 'display_name'))
        result = []
        family = None
        all_concept_names = list(self.parser.game_concepts.keys()) + [concept.display_name for concept in concepts]
        for concept in concepts:
            if concept.is_alias:
                continue
            if concept.family != family:
                family = concept.family
                result.append(f'== {family if family else "Uncategorized"} ==')
            result.append(f'=== {concept} ===')
            if concept.alias:
                alias_display_names = [alias.display_name for alias in concept.alias]
                result.append(f'{{{{hatnote|Aliases: {", ".join(self.formatter.format_localization_text(alias_display_name, all_concept_names) for alias_display_name in alias_display_names)}}}}}{{{{anchor|{"}}{{anchor|".join(alias_display_names)}}}}}')

            result.append(f'<section begin=autogenerated_concept_{concept.name} />')
            result.append(self.formatter.format_localization_text(concept.description, all_concept_names))
            result.append(f'<section end=autogenerated_concept_{concept.name} />')
        return result